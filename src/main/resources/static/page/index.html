<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>主页</title>
  <link type="text/css" href="../css/style.css" rel="stylesheet" />
  <style type="text/css">
  		th {
            text-align: left;
            padding: .5em .5em;
            font-weight: bold;
            background: #66677c;color: #fff;
        }
        tr td { border:1px solid #0094ff; }
        
        .skin {
			width : 100px;
			padding : 2px;
			visibility : hidden;
			position : absolute;
		}
  </style>
</head>
<body>
  <div align="center" style="background: #66677c;color: #fff;">SXJOB</div>
  <div align="center" style="width: 100%">
  	<table>
  		<thead>
	   		<tr>
	   		   <td>
	   		   	group组名：<input class="changeDiv" type="text" id="textGroupSelect" list="dbListForSelect" onChange="gradeChange()"/>
	                <datalist id="dbListForSelect">
	                 </datalist>
	   		   </td>
	   		   <td>
	   		   	 job任务名：<input class="changeDiv" type="text" id="textJobSelect" list="dataListForSelect" onChange="gradeTableChange()"/>
	                <datalist id="dataListForSelect">
	                 </datalist>
	   		   </td>
	   		   <td><input type="button" onClick="searchTable(1,10)" value="查询"></input></td>
	   		   <td><input type="button" onClick="addjob()" value="添加"></input></td>
	   		</tr>
	   	</thead>
  	</table>
   	<table style="width: 100%">
	   	<thead  id="tb">
	   		<tr id="paramValue"></tr>
   		</thead>
   		<tbody id="paramData">
   		</tbody>
   	</table>
   	<div id="fenye" style="display: none;">
   		<tr>
   			<td><input type="button" value="首页" onClick="page(1)"/></td>
   			<td><input type="button" value="上一页" onClick="page(2)"/></td>
   			<td>第<span id="pageNum"></span>页</td>
   			<td><input type="button" value="下一页" onClick="page(3)"/></td>
   			<td><input type="button" value="尾页" onClick="page(4)"/></td>
   			<td><input id="tz" type="text" value=""/></td>
   			<td><input type="button" value="跳转" onClick="page(5)"/></td>
   			<td>总页数:<span id="total"></span></td>
   			<td>条数:<input class="changeDiv" size="2" type="text" value="10" id="textNumSelect" list="dataNumListForSelect" />
	                <datalist id="dataNumListForSelect">
	                	<option>10</option>
	                	<option>20</option>
	                	<option>50</option>
	                	<option>100</option>
	                 </datalist>
	        </td>
   		</tr>
   	</div>
   <div id="menu" class="skin">
		<ul>
		   <li>升序</li>
		   <li>降序</li>
	 </ul>
	</div>
  </div>
  

	<div id="job" class="jobCla" style="display: none;"> 
	<h2><img src="" alt="" class="close" />添加job任务</h2> 
	<form id="jobForm" > 
	<div class="info"></div> 
	<div class="job">任务名：<input type="text" id="a1" name="user" class="text" /></div> 
	<div class="group">任务组：<input type="text" id="a2" name="pass" class="text" /></div> 
	<div class="url">请求地址：<input type="text" id="a3" name="requestUrl" class="text" /></div>
	<div class="body">请求参数：<input type="text" id="a4" name="requestBody" class="text" /></div>
	<div class="cron">表达式：<input type="text" id="a5" name="cron" class="text" /></div> 
	<div class="desc">任务描述：<input type="text" id="a6" name="description" class="text" /></div> 
	<div class="startDate">开始时间：<input type="text" id="a10" name="startDate" onfocus="WdatePicker({'dateFmt':'yyyy-MM-dd HH:mm:ss'})" class="text" autocomplete="off"/></div>
	<div class="endDate">结束时间：<input type="text" id="a11" name="endDate" onfocus="WdatePicker({'dateFmt':'yyyy-MM-dd HH:mm:ss'})" class="text" autocomplete="off"/></div>
	<div class="remark">备注：<input type="text" id="a7" name="remark" class="text" /></div>
	<div class="create">创建人：<input type="text" id="a8" name="create" class="text" /></div>
	<div style="display: none;" class="date">时间：<input type="text" id="a9" name="date" class="text" /></div>
	
	<div class="button"><input type="button" id="" name="sub" onclick="addSub()" class="submit" value="确认" />&nbsp;&nbsp;<input type="button" name="sub" class="submit" onclick="winClose()" value="取消" /></div> 
	</form> 
	</div> 
	
	<div id="jobUpdate" class="jobCla" style="display: none;"> 
	<h2><img src="" alt="" class="close" />修改job任务</h2> 
	<form id="jobForm" > 
	<div class="info"><input type="text" id="u0" style="display: none;" name="id" class="text" /></div> 
	<div class="job">任务名：<input type="text" id="u1" name="user" class="text" disabled="disabled"/></div> 
	<div class="group">任务组：<input type="text" id="u2" name="pass" class="text" disabled="disabled"/></div> 
	<div class="url">请求地址：<input type="text" id="u3" name="requestUrl" class="text" /></div>
	<div class="body">请求参数：<input type="text" id="u4" name="requestBody" class="text" /></div>
	<div class="cron">表达式：<input type="text" id="u5" name="cron" class="text" /></div> 
	<div class="desc">任务描述：<input type="text" id="u6" name="desc" class="text" /></div> 
	<div class="startDate">开始时间：<input type="text" id="u10" name="startDate" onfocus="WdatePicker({'dateFmt':'yyyy-MM-dd HH:mm:ss'})" class="text" autocomplete="off"/></div>
	<div class="endDate">结束时间：<input type="text" id="u11" name="endDate" onfocus="WdatePicker({'dateFmt':'yyyy-MM-dd HH:mm:ss'})" class="text" autocomplete="off"/></div>
	<div class="remark">备注：<input type="text" id="u7" name="remark" class="text" /></div>
	<div class="create">修改人：<input type="text" id="u8" name="create" class="text" /></div>
	<div style="display: none;" class="date">时间：<input type="text" id="u9" name="date" class="text" /></div>
	<div class="button"><input type="button" id="" name="sub" onclick="updateSub()" class="submit" value="确认" />&nbsp;&nbsp;<input type="button" name="sub" class="submit" onclick="winUpdateClose()" value="取消" /></div> 
	</form> 
	</div> 

  <script type="text/javascript" src="../js/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript" src="../js/My97DatePicker/WdatePicker.js"></script>
  <script type="text/javascript">
  
  window.onload=function(){}
  
  $(document).ready(function() { 
	jQuery.fn.extend({center:function(width,height){ 
		  return $(this).css("left", ($(window).width()-width)/2+$(window).scrollLeft()). 
		  css("top", ($(window).height()-height)/2+$(window).scrollTop()). 
		  css("width",width). 
		  css("height",height); 
		  } 
	}); 
  }); 
  
  $.get("/getDistinctGroupList",function(data,status){
	  var optionstring="";
	  $.each(data,function(key,value){
		  optionstring += "<option value=\"" + value + "\" ></option>";  
	  })
	  $("#dbListForSelect").html(optionstring); 
  });
  
  function gradeChange(){
	  var db = $("#textGroupSelect").val();
	  $.get("/getJobByGroupNameList?groupName="+db+"",function(data,status){
		  var optionstring="";  
		  $.each(data,function(key,value){
			  optionstring += "<option value=\"" + value + "\" ></option>";  
		  })
		  $("#textJobSelect").val("");
		  $("#dataListForSelect").html(optionstring); 
	  });
  }
  
  function addSub(){
	  var a1 = $("#a1").val();
	  $.ajaxSettings.async = false;
	  var jobNameExist=false;
	  $.get("/getJobNameExist?jobName="+a1,function(data,status){
		  jobNameExist = data;
	  });
	  $.ajaxSettings.async = true;
	  if(jobNameExist){
		  alert("该任务名已存在");
		  return;
	  }
	  
	  var addurl="/addJob";
	  var a2 = $("#a2").val();
	  var a3 = $("#a3").val();
	  var a4 = $("#a4").val();
	  var a5 = $("#a5").val();
	  var a6 = $("#a6").val();
	  var a7 = $("#a7").val();
	  var a8 = $("#a8").val();
	  var a10 = $("#a10").val();
	  a10 = a10.substring(0,19);    
	  a10 = a10.replace(/-/g,'/');
	  a10 = new Date(a10).getTime();
	  var a11 = $("#a11").val();
	  a11 = a11.substring(0,19);    
	  a11 = a11.replace(/-/g,'/');
	  a11 = new Date(a11).getTime();
	  if(''==a1 || ''==a2 || ''==a3 || ''==a5){
		  alert("请求参数有误");
		  return ;
	  }
	  //addurl = addurl + "?jobName="+a1+"&jobGroup="+a2+"&url="+a3+"&body="+a4+"&cronExpression="+a5+"&description="+a6+"&remark="+a7+"&createUser="+a8;
	  
	  var param = {"jobName":a1,"jobGroup":a2,"url":a3,"body":a4,"cronExpression":a5,"description":a6,"remark":a7,"createUser":a8,"startDate":a10,"endDate":a11}
	  
	  $.ajax({
		  url:addurl,
	  	  type:"post",
	  	  data:JSON.stringify(param),
	  	  contentType:"application/json;charset=utf-8",
	  	  dataType:"json",
	  	  success:function(data,status){
			  if(data == true){
				  alert("添加任务成功");
			  }else{
				  alert("添加任务失败");
				  return;
			  }
			  winClose();
			  searchTable(1,10);
		  }
	  });
	  
  }
  
  function addjob(){
	 // window.open('addeEject.html',"newwindow", "height=100, width=400, top=50%, left=50%, toolbar=no,menubar=no, scrollbars=no, resizable=no, location=no, status=no");
	  $("#job").show().center(450,460);//展现登陆框                                           
  }
  
  function winClose(){
	  $("#job").hide().center(450,460);//展现登陆框      
  }
  
  function gradeTableChange(){
	  var db = $("#textGroupSelect").val();
	  var table = $("#textJobSelect").val();
	  var valueParam="/jobTableParamList/"+db+"/"+table;
	  $.get(valueParam, function(data,status){
		  var paramValue="";
		  $.each(data,function(key,value){
			  if(null!=value){
				  paramValue += "<option value=\"" + value + "\" ></option>";
			  }
		  })
		  $("#dataSortListForSelect").html("");
		  $("#dataSortListForSelect").html(paramValue);
	  });
  }
  
  function searchTable(pageNum,pageSize){
	  var groupName = $("#textGroupSelect").val();
	  var jobName = $("#textJobSelect").val();
	  pageSize = $("#textNumSelect").val();
	  var valueParam="/jobTableParamList";
	  
	  $.get(valueParam, function(data,status){
		  var paramValue="";
		  var optionSortString="";  
		  $.each(data,function(key,value){
			  if(null!=value){
				  paramValue += "<th id='drawing' ondblclick='shuangji("+key+")' oncontextmenu=''>"+value+"</th>";
				  optionSortString += "<option value=\"" + value + "\" ></option>";
			  }
		  })
		  $("#paramValue").html(paramValue);
		  $("#dataSortListForSelect").html(optionSortString); 
	  });
	  handleTable(jobName,groupName,pageNum,pageSize);
  }
  
  function handleTable(jobName,groupName,pageNum,pageSize){
	  var param = "/queryJobTable";
	  var sort = $('#textSortSelect').val();
	  param = param +"?jobName="+jobName+"&groupName="+groupName+"&pageNum="+pageNum+"&pageSize="+pageSize+"&sort=1";
	  
	  $.get(param, function(data,status){
		  var code = data.respCode;
		  var memo = data.memo;
		  if(code != '00000'){
			  alert(memo);
			  return;
		  }
		  var d = data.data;
		  var pageNum = d.pageNum;
		  if('0'== pageNum){
			  pageNum='1';
		  }
		  $("#pageNum").html(pageNum);
		  var pageSize = d.pageSize;
		  var total = d.total;
		  $("#total").html(total);
		  var pdata="";
		  var dd = d.data;
		  $.each(dd,function(key,map){
			  var data="<tr>";
			  var index_key;
			  $.each(map,function(key,values){
				  if(key == 0){
					  index_key = values;
				  }
				  if(key == 7){
					  if(values){
						  values = "运行中";
					  }else{
						  values = "暂停";
					  }
				  }
				  if(null==values){
					  data += "<td></td>"; 
				  }else{
					  data += "<td>"+values+"</td>"; 
				  }
				   
			  })
			  data += "<td><input type='button' onClick='updatejob("+index_key+")' value='修改'></input><br>"+
			  "<input type='button' onClick='deljob("+index_key+")' value='删除'><br>"+
			  "<input type='button' onClick='startjob("+index_key+")' value='启用'><br>"+
			  "<input type='button' onClick='stopjob("+index_key+")' value='停止'><br></input></td>";
			  data += "<tr>"; 
			  pdata += data;
		  })
		  $("#paramData").empty();
		  $("#paramData").html(pdata);
		  if(""!=pdata){
			 $("#fenye").show(); 
		  }
		  if(""==pdata){
			 $("#fenye").hide(); 
		  }
	  });
  }
  
  function updateSub(){
	  var addurl="/updateJob";
	  var u1 = $("#u1").val();
	  var u2 = $("#u2").val();
	  var u3 = $("#u3").val();
	  var u4 = $("#u4").val();
	  var u5 = $("#u5").val();
	  var u6 = $("#u6").val();
	  var u7 = $("#u7").val();
	  var u8 = $("#u8").val();
	  var u10 = $("#u10").val();
	  u10 = u10.substring(0,19);    
	  u10 = u10.replace(/-/g,'/');
	  u10 = new Date(u10).getTime();
	  var u11 = $("#u11").val();
	  u11 = u11.substring(0,19);    
	  u11 = u11.replace(/-/g,'/');
	  u11 = new Date(u11).getTime();
	  if(''==u1 || ''==u2 || ''==u3 || ''==u5){
		  alert("请求参数有误");
		  return ;
	  }
	  //addurl = addurl + "?jobName="+u1+"&jobGroup="+u2+"&url="+u3+"&body="+u4+"&cronExpression="+u5+"&description="+u6+"&remark="+u7+"&modifyUser="+u8;

	  var param = {"jobName":u1,"jobGroup":u2,"url":u3,"body":u4,"cronExpression":u5,"description":u6,"remark":u7,"modifyUser":u8,"startDate":u10,"endDate":u11}
	  
	  $.ajax({
		  url:addurl,
	  	  type:"post",
	  	  data:JSON.stringify(param),
	  	  contentType:"application/json;charset=utf-8",
	  	  dataType:"json",
	  	  success:function(data,status){
			  if(data == true){
				  alert("修改任务成功");
			  }else{
				  alert("修改任务失败");
				  return;
			  }
			  winUpdateClose();
			  searchTable(1,10);
		  }
	  });
	  
  }
  
  function updatejob(key){
	  $.get("/getJobById?id="+key,function(data,status){
		  $.each(data,function(key,value){
			  var u="u"+key;
			  if(null!=value){
				  document.getElementById(u).value=value;
			  }
		  })
	  });
	  $("#jobUpdate").show().center(450,440);//展现登陆框
  }
  
  function winUpdateClose(){
	  $("#jobUpdate").hide().center(450,440);//展现登陆框
  }
  
  function deljob(key){
	  if(confirm("【删除job同时停止该任务的运行】您确认要删除吗？")){
		  $.get("/delJobById?id="+key,function(data,status){
			  if(data == true){
				  alert("删除任务成功");
			  }else{
				  alert("删除任务失败");
				  return;
			  }
			  searchTable(1,10);
		  });
	  }
  }
  
  function startjob(key){
	  if(confirm("您确认要开启吗？")){
		  $.get("/startJob?id="+key,function(data,status){
			  if(data == true){
				  alert("启用任务成功");
			  }else{
				  alert("启用任务失败");
				  return;
			  }
			  searchTable(1,10)
		  });
	  }
  }
  
  function stopjob(key){
	  if(confirm("您确认要停止吗？")){
		  $.get("/stopJob?id="+key,function(data,status){
			  if(data == true){
				  alert("停止任务成功");
			  }else{
				  alert("停止任务失败");
				  return;
			  }
			  searchTable(1,10)
		  });
	  }
  }
  
  function shuangji(key){
	  var tb=document.getElementById ("tb").rows[0]
	  var cell = tb.cells[key];
	  cell.style.display = 'none';
	  console.log(tb);
	  var row=document.getElementById("paramData").rows;
	  console.log(row);
	  for(var i = 0, len = row.length; i < len; i++){
	       var cell1 = row[i].cells[key];
	       console.log(cell1);
	       if(cell1 != undefined){
	    	   cell1.style.display = 'none';   
	       }
	       
	  }
  }
  
  function page(num){
	  var pageNum = $("#pageNum").text();
	  var pageNo = parseInt(pageNum);
	  var total = $("#total").text();
	  var totalNo = parseInt(total);
	  var textNumSelect = $("#textNumSelect").val();
	  var textNum = parseInt(textNumSelect);
	  if(num=='1'){
		 searchTable(1,textNum);
	  }else if(num=='2'){
		 if(pageNo>0){
			searchTable(pageNo-1,textNum);
		 } 
	  }else if(num=='3'){
		 var t = totalNo/textNum;
		 t = Math.ceil(t);
		 var p = pageNo+1;
		 if(t<=p){
			 p=t;
		 }
		 searchTable(p,textNum);
	  }else if(num=='4'){
		 var t = totalNo/textNum;
		 t = Math.ceil(t);
		 searchTable(t,textNum);
	  }else if(num=='5'){
		 var tz = $("#tz").val();
		 searchTable(tz,textNum);
	  }
  }
  
  function searchExportTable(){
	  var db = $("#textGroupSelect").val();
	  var condition = $("#condition").val();
	  condition = condition.toUpperCase();
	  var table = $("#textJobSelect").val();
	  var param = "/exportTable/"+db+"/"+table+"";
	  var sort = $('#textSortSelect').val();
	  if('' != condition){
		  param = param + "?condition="+condition;
	  }
	  if('' != sort){
		  param = param + "&sort="+sort
	  }
	  if(confirm("您将导出当前页面查询出的所有数据，确定吗？")){
		  window.location.href=param;
		  alert("OK");
	  }else{
		  alert("NO");
	  }
  }
  
  
  //alert(GetQueryString("phone"));
  var phone=GetQueryString("phone");
  var loginType=GetQueryString("loginType");
  var channelCode=GetQueryString("channelCode");
  $('#phone').val(phone);
  $('#loginType').val(loginType);
  $('#channelCode').val(channelCode);
  function GetQueryString(name)
  {
       var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
       var r = window.location.search.substr(1).match(reg);
       if(r!=null)return  unescape(r[2]); return null;
  }
  </script>
</body>
</html>